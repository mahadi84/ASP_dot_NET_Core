


# 6) WEB Layer (MVC + Bootstrap UI + Cookie auth + Admin policy)

## 6.1 Program.cs

✅ এখানে:

* DB connect
* Rules options bind
* Cookie auth + secure cookie
* Admin authorization policy
* Seed admin user (startup এ admin create করবে)

`src/OnlineBanking.Web/Program.cs`

```csharp
using System.Security.Claims;
using Microsoft.AspNetCore.Authentication.Cookies;
using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Options;
using OnlineBanking.Application.Contracts;
using OnlineBanking.Application.Options;
using OnlineBanking.Infrastructure.Persistence;
using OnlineBanking.Infrastructure.Services;
using OnlineBanking.Infrastructure.Security;
using OnlineBanking.Domain.Entities;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllersWithViews(options =>
{
    options.Filters.Add(new Microsoft.AspNetCore.Mvc.AutoValidateAntiforgeryTokenAttribute());
});

builder.Services.Configure<BankingRulesOptions>(builder.Configuration.GetSection("BankingRules"));

builder.Services.AddDbContext<AppDbContext>(opt =>
{
    var cs = builder.Configuration.GetConnectionString("MySql");
    opt.UseMySql(cs, ServerVersion.AutoDetect(cs));
});

// Auth cookie
builder.Services.AddAuthentication(CookieAuthenticationDefaults.AuthenticationScheme)
    .AddCookie(opt =>
    {
        opt.LoginPath = "/Account/Login";
        opt.LogoutPath = "/Account/Logout";
        opt.AccessDeniedPath = "/Account/Login";
        opt.Cookie.HttpOnly = true;
        opt.Cookie.SameSite = SameSiteMode.Strict;
        opt.Cookie.SecurePolicy = CookieSecurePolicy.Always; // HTTPS required
        opt.SlidingExpiration = true;
        opt.ExpireTimeSpan = TimeSpan.FromMinutes(30);
    });

builder.Services.AddAuthorization(opt =>
{
    opt.AddPolicy("AdminOnly", policy =>
        policy.RequireClaim("IsAdmin", "true"));
});

builder.Services.AddScoped<AuditWriter>();
builder.Services.AddScoped<IAuthService, AuthService>();
builder.Services.AddScoped<IBankingService, BankingService>();
builder.Services.AddScoped<IStatementPdfService, StatementPdfService>();
builder.Services.AddScoped<IAdminService, AdminService>();

var app = builder.Build();

// Seed Admin on startup
using (var scope = app.Services.CreateScope())
{
    var db = scope.ServiceProvider.GetRequiredService<AppDbContext>();
    await db.Database.MigrateAsync();

    var adminCfg = app.Configuration.GetSection("AdminSeed");
    var email = adminCfg["Email"]!;
    var pass = adminCfg["Password"]!;
    var name = adminCfg["Name"] ?? "Admin";
    var city = adminCfg["City"] ?? "Dhaka";

    if (!await db.Customers.AnyAsync(c => c.Email == email.ToLower()))
    {
        // create admin with random 5-digit account
        string acc;
        int guard = 0;
        do
        {
            acc = Random.Shared.Next(10000, 100000).ToString();
            guard++;
            if (guard > 50) throw new Exception("Could not seed admin account number.");
        } while (await db.Customers.AnyAsync(x => x.AccountNumber == acc));

        var admin = new Customer
        {
            Name = name,
            Email = email.ToLower(),
            City = city,
            AccountNumber = acc,
            PasswordHash = PasswordHasher.Hash(pass),
            IsAdmin = true,
            Account = new Account { Balance = 0m }
        };

        db.Customers.Add(admin);
        await db.SaveChangesAsync();

        db.AuditLogs.Add(new AuditLog
        {
            Action = "SYSTEM_SEED_ADMIN",
            ActorAccountNumber = "SYSTEM",
            TargetAccountNumber = acc,
            Message = $"Admin seeded: {email}"
        });
        await db.SaveChangesAsync();

        Console.WriteLine($"Seeded Admin AccountNumber: {acc}");
    }
}

if (!app.Environment.IsDevelopment())
{
    app.UseExceptionHandler("/Home/Error");
    app.UseHsts();
}

app.UseHttpsRedirection();
app.UseStaticFiles();

// basic security headers
app.Use(async (ctx, next) =>
{
    ctx.Response.Headers["X-Content-Type-Options"] = "nosniff";
    ctx.Response.Headers["X-Frame-Options"] = "DENY";
    ctx.Response.Headers["Referrer-Policy"] = "no-referrer";
    ctx.Response.Headers["Content-Security-Policy"] =
        "default-src 'self'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'";
    await next();
});

app.UseRouting();
app.UseAuthentication();
app.UseAuthorization();

app.MapControllerRoute(
    name: "default",
    pattern: "{controller=Banking}/{action=Dashboard}/{id?}");

app.Run();
```

---

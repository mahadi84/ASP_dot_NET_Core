



===========================================================
                         TRY-02
===========================================================

CREATE TABLE branches (
    id INT AUTO_INCREMENT PRIMARY KEY,
    branch_code INT(20) UNIQUE NOT NULL,
    branch_name VARCHAR(100) NOT NULL,
    vault_balance DECIMAL(18, 2) DEFAULT 0.00,
    row_version INT DEFAULT 1, 
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP, 
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);


==========================
     DOMAIN LAYER
==========================

---------- ENTITIES AND LOGIC----------

using CBS.Domain.Common;


namespace CBS.Domain.Entities;

public class Branch
{
    public int Id { get; set; }
    public string BranchCode { get; set; }
    public string BranchName { get; set; }
    public decimal VaultBalance { get; private set; }
    public int RowVersion { get; set; } 
    public bool IsActive { get; private set; } = true;
    public DateTime CreatedAt { get; set; } = DateTime.Now; 
    public DateTime? UpdatedAt { get; set; } 

    public Result<bool> UpdateVaultBalance(decimal amount)
    {
        if (VaultBalance < amount) return Result<bool>.Failure("Insufficient Vault Balance!");
        VaultBalance -= amount;
        return Result<bool>.Success(true);
    }

    public void UpdateInfo(string code, string name)
    {
        BranchCode = code;
        BranchName = name;
    }

    public void Deactivate() => IsActive = false; // Soft Delete
    public void Activate() => IsActive = true;
}


======================================
          APPLICATION LAYER
======================================

--DTO--
--INTERFACE with DTO and Global success/failed message Carrier--


======================================
          INFRASTRUCTURE LAYER
======================================

---IMPLEMENT INTERFACE from Application Layer ------


======================================
          WEB/PRESENTATION LAYER
======================================

----- CONTOLLER -------
CALL INTERFACE from Application Layer

------- VIEWS ---------------
INCLUDE DTO from Applicaiton Layer



















===========================================================
                         TRY-01
===========================================================
########## Tables

 CREATE  TABLE branches (
    id INT AUTO_INCREMENT PRIMARY KEY,
    branch_code VARCHAR(10) UNIQUE NOT NULL,
    branch_name VARCHAR(100) NOT NULL,
    vault_balance DECIMAL(18, 2) DEFAULT 0.00,
    is_active BOOLEAN DEFAULT TRUE
);


CREATE TABLE audit_logs (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    branch_id INT NOT NULL,
    user_id INT,
    action VARCHAR(100),
    old_value VARCHAR(100),
    new_value VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (branch_id) REFERENCES branches(id),
    FOREIGN KEY (user_id) REFERENCES users(id)
);



######################################################################## 
                                Domain Layer
######################################################################## 

namespace CBS.Domain.Common
{
    public class Result<T>
    {
        public bool IsSuccess { get; }
        public T Data { get; }
        public string Message { get; }
        public List<string> Errors { get; }

        protected Result(bool isSuccess, T data, string message, List<string> errors = null)
        {
            IsSuccess = isSuccess;
            Data = data;
            Message = message;
            Errors = errors ?? new List<string>();
        }

        public static Result<T> Success(T data, string message = "Operation successful") 
            => new Result<T>(true, data, message);

        public static Result<T> Failure(string message, List<string> errors = null) 
            => new Result<T>(false, default, message, errors);
    }
}

-----------------------

// Domain/Entities/AuditLog.cs
public class AuditLog
{
    public long Id { get; set; }
    public int BranchId { get; set; }
    public int? UserId { get; set; }
    public string Action { get; set; }
    public string OldValue { get; set; }
    public string NewValue { get; set; }
    public DateTime CreatedAt { get; set; } = DateTime.Now;
}

// Domain/Entities/Branch.cs
public class Branch
{
    public int Id { get; set; }
    public string BranchCode { get; set; }
    public string BranchName { get; set; }
    public decimal VaultBalance { get; private set; }
    public bool IsActive { get; private set; } = true;

   public Result<bool> UpdateVaultBalance(decimal amount) {
    if (VaultBalance < amount) return Result<bool>.Failure("Insufficient Vault Balance!");
    VaultBalance -= amount;
    return Result<bool>.Success(true);
}

    public void UpdateInfo(string code, string name)
    {
        BranchCode = code;
        BranchName = name;
    }

    public void Deactivate() => IsActive = false; // Soft Delete
    public void Activate() => IsActive = true;
}



######################################################################## 
                         Application Layer
######################################################################## 

এখানে আমরা DTO এবং Interface রাখবো। আপনার তৈরি করা Result<T> ক্লাসটি এখানে রেসপন্স হিসেবে ব্যবহার করা হবে।
C#

// Application/DTOs/BranchDTOs.cs
public record CreateBranchDTO(string BranchCode, string BranchName, decimal InitialBalance);
public record UpdateBranchDTO(int Id, string BranchCode, string BranchName);


// Application/Interfaces/IBranchService.cs
public interface IBranchService
{
       //CreateBranchDTO ডেটা ট্রান্সফার এবং IBranchService ব্যবসায়িক লজিক আলাদা করে, যা কোডটিকে আরো পরিষ্কার, মেইনটেইনেবল, এবং টেস্টেবল করে তোলে।
    Task<Result<int>> CreateAsync(CreateBranchDTO dto, int userId);
    Task<Result<bool>> UpdateAsync(UpdateBranchDTO dto, int userId);
    Task<Result<bool>> ToggleStatusAsync(int id, int userId);
    Task<(IEnumerable<Branch> Items, int TotalCount)> GetPagedAsync(string search, int page, int size);
}



// Application/Interfaces/IAuditService.cs
public interface IAuditService
{
    Task LogAsync(int branchId, int? userId, string action, string oldVal, string newVal);
}


#########################################################################
                    Infrastructure Layer
#########################################################################

// Infrastructure/Services/BranchService.cs
public class BranchService : IBranchService
{
    private readonly ApplicationDbContext _context;
    private readonly IAuditService _audit;

    public BranchService(ApplicationDbContext context, IAuditService audit)
    {
        _context = context;
        _audit = audit;
    }

    // CREATE
    public async Task<Result<int>> CreateAsync(CreateBranchDTO dto, int userId)
    {

      // Check if the branch code already exists
          var existingBranch = await _context.Branches
                                             .FirstOrDefaultAsync(b => b.BranchCode == dto.BranchCode);
          if (existingBranch != null)
          {
              return Result<int>.Failure("Branch code already exists.");
          }

        var branch = new Branch();
        branch.UpdateInfo(dto.BranchCode, dto.BranchName); // ডোমেইন মেথড ব্যবহার

        _context.Branches.Add(branch);
        await _context.SaveChangesAsync();

        await _audit.LogAsync(branch.Id, userId, "INSERT", "", $"Code: {branch.BranchCode}, Name: {branch.BranchName}");

        return Result<int>.Success(branch.Id, "Branch created successfully!");
    }

    // UPDATE
    public async Task<Result<bool>> UpdateAsync(UpdateBranchDTO dto, int userId)
    {

        // প্রথমে চেক করুন যে ব্রাঞ্চ কোডটি ডুপ্লিকেট কিনা (যদি একই ব্রাঞ্চের কোড পরিবর্তন করা হচ্ছে)
         var existingBranch = await _context.Branches
                                             .Where(b => b.BranchCode == dto.BranchCode && b.Id != dto.Id)
                                             .FirstOrDefaultAsync();
     
         // যদি ব্রাঞ্চ কোডটি ইতিমধ্যেই অন্য কোনো ব্রাঞ্চে থাকে, তাহলে ত্রুটি বার্তা দিন
         if (existingBranch != null)
         {
             return Result<bool>.Failure("Branch code already exists.");
         }
      
        var branch = await _context.Branches.FindAsync(dto.Id);
        if (branch == null) return Result<bool>.Failure("Branch not found!");

        string oldValues = $"Name: {branch.BranchName}";
        branch.UpdateInfo(dto.BranchCode, dto.BranchName);

        await _context.SaveChangesAsync();
        await _audit.LogAsync(branch.Id, userId, "UPDATE", oldValues, $"Name: {dto.BranchName}");

        return Result<bool>.Success(true, "Branch updated successfully!");
    }

    // SOFT DELETE / INACTIVE
    public async Task<Result<bool>> ToggleStatusAsync(int id, int userId)
    {
        var branch = await _context.Branches.FindAsync(id);
        if (branch == null) return Result<bool>.Failure("Branch not found!");

        string action = branch.IsActive ? "DEACTIVATE" : "ACTIVATE";
        if (branch.IsActive) branch.Deactivate(); else branch.Activate();

        await _context.SaveChangesAsync();
        await _audit.LogAsync(id, userId, action, (!branch.IsActive).ToString(), branch.IsActive.ToString());

        return Result<bool>.Success(true, $"Branch {action} successfully!");
    }

    // SEARCH & PAGINATION
    public async Task<(IEnumerable<Branch> Items, int TotalCount)> GetPagedAsync(string search, int page, int size)
    {
        var query = _context.Branches.AsNoTracking().AsQueryable();

        if (!string.IsNullOrWhiteSpace(search))
        {
            query = query.Where(b => b.BranchName.Contains(search) || b.BranchCode.Contains(search));
        }

        int totalCount = await query.CountAsync();
        var items = await query.OrderByDescending(b => b.Id)
                               .Skip((page - 1) * size)
                               .Take(size)
                               .ToListAsync();

        return (items, totalCount);
    }
}


---------

// Infrastructure/Services/AuditLogService.cs
public class AuditLogService : IAuditService
{
    private readonly ApplicationDbContext _context;

    public AuditLogService(ApplicationDbContext context)
    {
        _context = context;
    }

    public async Task LogAsync(int branchId, int? userId, string action, string oldVal, string newVal)
    {
        var log = new AuditLog
        {
            BranchId = branchId,
            UserId = userId,
            Action = action,
            OldValue = oldVal,
            NewValue = newVal,
            CreatedAt = DateTime.Now
        };

        _context.AuditLogs.Add(log);
        await _context.SaveChangesAsync();
    }
}

------------

Dependency Injection (Program.cs)
সবশেষে, এই সার্ভিসগুলোকে .NET Container-এ রেজিস্টার করতে হবে।
// Presentation/Program.cs
builder.Services.AddScoped<IAuditService, AuditLogService>();
builder.Services.AddScoped<IBranchService, BranchService>();




